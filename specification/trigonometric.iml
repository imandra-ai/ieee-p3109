[@@@import ErrorPropagation, "ErrorPropagation.iml"]
[@@@import Util, "dune:math"]

open ErrorPropagation

(* IEEE 754:
  The functions sin, cos, tan, asin, acos, atan, and atan2 measure angles in radians.
  The functions sinPi, cosPi, asinPi, acosPi, atanPi, and atan2Pi measure angles in half-revolutions. *)

let sin (x : real) : (real, string) Result.t =
  let term (x : real) (n : int) : (real, string) Result.t =
    let* fac = Util.rfactorial (2 * n + 1) in
    Ok ((Util.ripow (- 1.0) n) *. (Util.ripow x (2 * n + 1) /. fac))
  in
  Util.sum (fun i _ -> term x i) 0 10

let cos (x : real) : (real, string) Result.t =
  let term (x : real) (n : int) : (real, string) Result.t =
    let* fac = Util.rfactorial (2 * n) in
    Ok ((Util.ripow (- 1.0) n) *. (Util.ripow x (2 * n) /. fac))
  in
  Util.sum (fun i _ -> term x i) 0 10

let tan (x : real) : (real, string) Result.t =
  let* cos_x = cos x in
  let* sin_x = sin x in
  if cos_x = 0.0 then
    Error "division by zero"
  else
    Ok (sin_x /. cos_x)

let sinh (x : real) : (real, string) Result.t = Ok 0.0 (* TODO *)
let cosh (x : real) : (real, string) Result.t = Ok 0.0 (* TODO *)
let tanh (x : real) : (real, string) Result.t = Ok 0.0 (* TODO *)

let arcsin (x : real) : (real, string) Result.t = Ok 0.0 (* TODO *) (* sin _ = x*)
let arccos (x : real) : (real, string) Result.t = Ok 0.0 (* TODO *)
let arctan (x : real) : (real, string) Result.t = Ok 0.0 (* TODO *)

let arcsinh (x : real) : (real, string) Result.t = Ok 0.0 (* TODO *)
let arccosh (x : real) : (real, string) Result.t = Ok 0.0 (* TODO *)
let arctanh (x : real) : (real, string) Result.t = Ok 0.0 (* TODO *) (* 1/2 * ln ((1 + x)/(1 - x)) *)


(* Some properties *)

let pi = 3.1415926535897932384626433832795

verify (sin 0.0 = Ok 0.0) [@@by auto]

verify (
  match sin pi with
  | Ok r -> 0.0 <=. r && r <=. 0.0000000001
  | _ -> false)
  [@@by auto]

verify (
  match sin (pi /. 2.0) with
  | Ok r -> 0.99999999999999999 <=. r && r <=. 1.00000000000000001
  | _ -> false)
  [@@by auto]

verify (cos 0.0 = Ok 1.0) [@@by auto]

verify (
  match cos pi with
  | Ok r -> -1.000001 <=. r && r <=. -0.999999
  | _ -> false)
  [@@by auto]

verify (
  match cos (pi /. 2.0) with
  | Ok r -> 0.0 <=. r && r <=. 0.0000000001
  | _ -> false)
  [@@by auto]
